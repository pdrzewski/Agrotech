<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento AgroTech</title>
    <link rel="stylesheet" href="style.css">
    <script src="./../js/alerta.js"></script>
</head>

<body onload="condicaoSilo()">
    <div class="header">
        <div class="navbar">
            <img src="./img/Logo-Azul.png">
            <div class="div_esquerda">
                <li class="agora">
                    <a href="#monitoramento">Monitoramento</a>
                </li>
                <li class="">
                    <a href="#historico">Histórico</a>
                </li>
                <a href="https://agrotechsptech-768654.atlassian.net/servicedesk/customer/user/login?destination=portals">Suporte</a>
            </div>
            <div>
                <img class="img_fundo_azul" src="./img/Agrotech-Fundo-Azul.png">
            </div>
            <div class="div_direita">
                <li class="">
                    <a href="./index.html">Sair</a>
                </li>
                <li class="">
                    <div id="div_usuario">Usuário</div>
                </li>
            </div>
            <img src="./img/person-circle.svg" alt="Usuário">
        </div>
    </div>

    <main>
        <div class="main-container">
            <div class="monitoramento-container">
                <div class="monitoramento" id="monitoramento">
                    <div>
                        <h6>Monitoramento em tempo real</h6>
                    </div>
                    <div class="kpis">
                        <div class="alertaInstavel">
                            <p>⚠️ Quantidade de silos instáveis: <span id="alertaInstavel"></span> ⚠️</p>
                        </div>
                        <div class="alertaTotal">
                            <p>⚠️ Quantidade total de silos: <span id="alertaTotal"></span> ⚠️</p>
                        </div>
                        <div class="alertaEstavel">
                            <p>⚠️ Quantidade de silos estáveis: <span id="alertaEstavel"></span> ⚠️</p>
                        </div>
                    </div>

                </div>

                <div class="carousel-dashboard-container">
                    <!-- Carrossel -->
                    <div class="carousel">
                        <div class="carousel-inner">
                            <div class="carousel-item active">
                                <div class="grid-silos">
                                    <div class="silo">Silo 1: <span id="idSilo1" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 2: <span id="idSilo2" class="status-instavel">Instável</span>
                                    </div>
                                    <div class="silo">Silo 3: <span id="idSilo3" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 4: <span id="idSilo4" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 5: <span id="idSilo5" class="status-instavel">Instável</span>
                                    </div>
                                    <div class="silo">Silo 6: <span id="idSilo6" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 7: <span id="idSilo7" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 8: <span id="idSilo8" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 9: <span id="idSilo9" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 10: <span id="idSilo10"
                                            class="status-instavel">Instável</span></div>
                                </div>
                            </div>

                            <!-- Slide 2 -->
                            <div class="carousel-item">
                                <div class="grid-silos">
                                    <div class="silo">Silo 11: <span id="idSilo11"
                                            class="status-instavel">Instável</span></div>
                                    <div class="silo">Silo 12: <span id="idSilo12" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 13: <span id="idSilo13" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 14: <span id="idSilo14"
                                            class="status-instavel">Instável</span></div>
                                    <div class="silo">Silo 15: <span id="idSilo15" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 16: <span id="idSilo16"
                                            class="status-instavel">Instável</span></div>
                                    <div class="silo">Silo 17: <span id="idSilo17" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 18: <span id="idSilo18" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 19: <span id="idSilo19" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 20: <span id="idSilo20"
                                            class="status-instavel">Instável</span></div>
                                </div>
                            </div>

                            <!-- Slide 3 -->
                            <div class="carousel-item">
                                <div class="grid-silos">
                                    <div class="silo">Silo 21: <span id="idSilo21" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 22: <span id="idSilo22" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 23: <span id="idSilo23"
                                            class="status-instavel">Instável</span></div>
                                    <div class="silo">Silo 24: <span id="idSilo24" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 25: <span id="idSilo25"
                                            class="status-instavel">Instável</span></div>
                                    <div class="silo">Silo 26: <span id="idSilo26" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 27: <span id="idSilo27" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 28: <span id="idSilo28" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 29: <span id="idSilo29" class="status-estavel">Estável</span>
                                    </div>
                                    <div class="silo">Silo 30: <span id="idSilo30"
                                            class="status-instavel">Instável</span></div>
                                </div>
                            </div>
                        </div>

                        <button class="carousel-control prev" onclick="prevSlide()">‹</button>
                        <button class="carousel-control next" onclick="nextSlide()">›</button>
                    </div>
                    <div id="conteudo-container" class="conteudo-extra-container"></div>
                </div>
            </div>

            <div class="historico" id="historico">
                <div>
                    <h6>Histórico dos dados</h6>
                </div>
                <button onclick="gerar()">Gerar Histórico do Silo</button>
                <div id="tabelaHistorico">
                    <h1>Silo <span id="tabelaSilo"></span></h1>
                    <p id="dataHistorico"></p>
                    <div class="tabelas">
                        <div id="tabela_historico1" class="alinhadorTabela"></div>
                        <div id="tabela_historico2" class="alinhadorTabela"></div>
                        <div id="tabela_historico3" class="alinhadorTabela"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="footer">
        <div>
            <img src="./img/Agrotech-Fundo-Azul.png" alt="logo/agrotech" id="agrotech_logo">
            <p class="texto_footer">Empresa número 1 em tecnologia no <br> setor agropecuário</p>
            <div class="div_icons">
                <img src="img/icons8-facebook-circled-50.png" alt="icon/facebook" id="facebook">
                <img src="img/icons8-twitter-bird-30.png" alt="icon/twitter" id="twitter">
                <img src="img/icons8-instagram-26.png" alt="icon/instagram" id="instagram">
                <img src="img/icons8-linkedin-30.png" alt="icon/linkedin" id="linkedin">
                <img src="img/icons8-youtube-50.png" alt="icon/youtube" id="youtube">
            </div>
        </div>
        <div class="lado_direito">
            <div>
                <h2>Fundadores</h2>
                <p>Giovanna Tracinkas</p>
                <p>Guilherme Aoki</p>
                <p>Guilherme Barros</p>
                <p>João Oliveira</p>
                <p>Pedro Tomaszewski</p>
                <p>Kauã Medeiros</p>
            </div>
        </div>
        <div class="texto_footer">
            <h2>Mais informações</h2>
            <a href="index.html">Home</a> <br>
            <a href="login.html">Login</a> <br>
            <a href="calculadora.html">Simulação</a>
        </div>
        <div class="texto_footer">
            <h2>Contate-nos</h2>
            <p>vendas@agrotech.com</p>
            <p>(11) 98838-0889</p>
            <p>Rua Haddock Lobo, 595. -</p>
            <p>Cerqueira César, São Paulo - SP</p>
            <p>01414-001</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        const carouselInner = document.querySelector('.carousel-inner');
        const carouselItems = document.querySelectorAll('.carousel-item');
        const conteudoContainer = document.getElementById('conteudo-container');
        const carousel = document.querySelector('.carousel');
        let currentIndex = 0;
        let intervalId;
        let timeoutId;

        function goToSlide(index) {
            if (index < 0) index = carouselItems.length - 1;
            else if (index >= carouselItems.length) index = 0;

            carouselInner.style.transform = `translateX(-${index * 99}%)`;
            currentIndex = index;

            document.querySelectorAll('.indicator').forEach((indicator, i) => {
                indicator.classList.toggle('active', i === currentIndex);
            });
        }

        function nextSlide() {
            goToSlide(currentIndex + 1);
        }

        function prevSlide() {
            stopCarousel();
            goToSlide(currentIndex - 1);
        }

        function startCarousel() {
            stopCarousel();
            intervalId = setInterval(nextSlide, 7000);
        }

        function stopCarousel() {
            clearInterval(intervalId);
            clearTimeout(timeoutId);
        }

        // Inicia o carrossel
        startCarousel();

        // Pausa quando o mouse está sobre o carrossel
        carousel.addEventListener('mouseenter', stopCarousel);
        carousel.addEventListener('mouseleave', startCarousel);

        function alterarVisibilidade(event) {
            tabelaHistorico.style.display = 'none';
            const silo = event.currentTarget;
            const nome = silo.textContent.split(':')[0].trim();

            if (conteudoContainer.dataset.current === nome) {
                conteudoContainer.innerHTML = '';
                conteudoContainer.removeAttribute('data-current');
            } else {
                conteudoContainer.dataset.current = nome;
                conteudoContainer.innerHTML = `
                <div class="conteudo-extra">
                    <div class="silo-nome">${nome}</div>
                    <div class="sensores">
                        <div class="caixaSensor">
                            <div class="caixaMaximo"></div><p>Máximo</p>
                        </div>
                        <div class="caixaSensor">
                            <div class="caixaAtual"></div><p>Atual</p>
                        </div>
                        <div class="caixaSensor">
                            <div class="caixaMinimo"></div><p>Mínimo</p>
                        </div>
                    </div>
                    
                    <!-- Linha Superior: 3 Gráficos de Temperatura -->
                    <div class="linha-graficos">
                        <div class="grafico-box">
                            <h4>Temperatura - Sensor 1 (topo)</h4>
                            <canvas id="grafico_temperatura_1"></canvas>
                        </div>
                        <div class="grafico-box">
                            <h4>Temperatura - Sensor 2 (meio)</h4>
                            <canvas id="grafico_temperatura_2"></canvas>
                        </div>
                        <div class="grafico-box">
                            <h4>Temperatura - Sensor 3 (base)</h4>
                            <canvas id="grafico_temperatura_3"></canvas>
                        </div>
                    </div>

                    <!-- Linha Inferior: 3 Gráficos de Umidade -->
                    <div class="linha-graficos">
                        <div class="grafico-box">
                            <h4>Umidade - Sensor 1 (topo)</h4>
                            <canvas id="grafico_umidade_1"></canvas>
                        </div>
                        <div class="grafico-box">
                            <h4>Umidade - Sensor 2 (meio)</h4>
                            <canvas id="grafico_umidade_2"></canvas>
                        </div>
                        <div class="grafico-box">
                            <h4>Umidade - Sensor 3 (base)</h4>
                            <canvas id="grafico_umidade_3"></canvas>
                        </div>
                    </div>
                </div>
                `;

                criarGraficos(nome);
            }
        }

        document.querySelectorAll('.silo').forEach(silo => {
            silo.addEventListener('click', alterarVisibilidade);
        });

        let proximaAtualizacao;

        function condicaoSilo() {
            console.log('OK')
            fetch(`/medidas/condicao`, { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) throw new Error('Erro na API');
                    return response.json();
                })
                .then(silos => {
                    console.log(`Dados recebidos: ${JSON.stringify(silos)}`);

                    var temperaturaTemporaria = 0;
                    var umidadeTemporaria = 0;
                    var qtdAlerta = 0;

                    // Atualiza temperatura
                    for (var i = 0; i < silos.length; i++) {
                        var index = i;
                        if (i > 10) {
                            index = 3;
                        }

                        var instavel = false;
                        const fatorVariacao = (silos[index].fkSensor % 10) * 0.01 + 0.02;

                        temperaturaTemporaria = Number(silos[index].temperatura);
                        umidadeTemporaria = Number(silos[index].umidade);

                        if (temperaturaTemporaria > 30 || temperaturaTemporaria < 20 ||
                            (temperaturaTemporaria * (1 + fatorVariacao)) > 30 || (temperaturaTemporaria * (1 + fatorVariacao)) < 20 ||
                            (temperaturaTemporaria * (1 - fatorVariacao)) > 30 || (temperaturaTemporaria * (1 - fatorVariacao)) < 20 ||
                            umidadeTemporaria > 14 || umidadeTemporaria < 12 ||
                            (umidadeTemporaria * (1 + fatorVariacao)) > 14 || (umidadeTemporaria * (1 + fatorVariacao)) < 12 ||
                            (umidadeTemporaria * (1 - fatorVariacao)) > 14 || (umidadeTemporaria * (1 - fatorVariacao)) < 12
                        ) {
                            document.getElementById(`idSilo${i + 1}`).className = 'status-instavel'
                            document.getElementById(`idSilo${i + 1}`).innerHTML = 'Instável'
                            qtdAlerta += 1;
                        } else {
                            document.getElementById(`idSilo${i + 1}`).className = 'status-estavel'
                            document.getElementById(`idSilo${i + 1}`).innerHTML = 'Estável'
                        }
                    }
                    alertaInstavel.innerHTML = qtdAlerta;
                    alertaTotal.innerHTML = silos.length;
                    alertaEstavel.innerHTML = silos.length - qtdAlerta;

                })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function criarGraficos(nomeDoSilo) {
            var idSilo = nomeDoSilo.split(' ')[1].trim();
            console.log('Número do silo: ', idSilo);
            var ID_SILO_ATUAL = sessionStorage.setItem('idSiloAtual', idSilo);

            if (Number(idSilo) > 10) {
                idSilo = 4;
            }

            fetch(`/medidas/sensores/${idSilo}`, {
                cache: 'no-store',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    return response.json();
                })
                .then(sensores => {
                    console.log('Sensores recebidos:', sensores);


                    const sensoresMeio = sensores.filter(sensor => sensor.id % 3 === 2);
                    if (sensoresMeio.length === 0) {
                        throw new Error('Nenhum sensor do meio encontrado');
                    }

                    const sensorMeio = sensoresMeio[0]; // Pega o primeiro sensor do meio encontrado

                    // Atualiza os dados para todos os gráficos usando o sensor do meio como base
                    for (let i = 1; i <= 3; i++) {
                        buscarDadosESensor(idSilo, sensorMeio.id, i);
                    }
                })
                .catch(error => {
                    console.error('Erro ao obter sensores:', error);
                    alert('Erro ao carregar sensores. Verifique o console para detalhes.');
                });
        }

        function buscarDadosESensor(idSilo, idSensor, graficoIndex) {
            fetch(`/medidas/ultimas/${idSilo}/${idSensor}`, {
                cache: 'no-store'
            })
                .then(response => {
                    if (!response.ok) throw new Error('Erro na API');
                    return response.json();
                })
                .then(resposta => {
                    console.log(`Dados recebidos do sensor ${idSensor}:`, resposta);
                    plotarGrafico(resposta, idSensor, graficoIndex);
                })
                .catch(error => {
                    console.error(`Erro ao buscar dados do sensor ${idSensor}:`, error);
                });
        }

        function plotarGrafico(resposta, idSensor, graficoIndex) {

            console.log('iniciando plotagem do gráfico...');
            var ID_SENSOR_ATUAL = sessionStorage.setItem('idSensorAtual', idSensor)
            // Criando estrutura para plotar gráfico - labels
            let labels = [];

            // Criando estrutura para plotar gráfico - dados
            let dadosTemp = {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura atual',
                        data: [],
                        backgroundColor: '#3cff66',
                        borderColor: '#3cff66',
                    },
                    {
                        label: 'Temperatura máxima',
                        data: [30, 30, 30, 30, 30, 30, 30, 30, 30, 30],
                        backgroundColor: '#f12c2c',
                        borderColor: '#f12c2c',
                    },
                    {
                        label: 'Temperatura mínima',
                        data: [20, 20, 20, 20, 20, 20, 20, 20, 20, 20],
                        backgroundColor: '#1c55f1',
                        borderColor: '#1c55f1',
                    }
                ]
            }

            let dadosUmid = {
                labels: labels,
                datasets: [
                    {
                        label: 'Umidade atual',
                        data: [],
                        backgroundColor: '#3cff66',
                        borderColor: '#3cff66',
                    },
                    {
                        label: 'Umidade máxima',
                        data: [14, 14, 14, 14, 14, 14, 14, 14, 14, 14],
                        backgroundColor: '#f12c2c',
                        borderColor: '#f12c2c',
                    },
                    {
                        label: 'Umidade mínima',
                        data: [12, 12, 12, 12, 12, 12, 12, 12, 12, 12],
                        backgroundColor: '#1c55f1',
                        borderColor: '#1c55f1',
                    }
                ]
            }

            const dados = {
                labels: labels,
                temperatura: dadosTemp.datasets[0].data,
                umidade: dadosUmid.datasets[0].data
            };
            const dadosLimitados = resposta.slice(-10);

            dadosLimitados.forEach((registro, i) => {
                let temperatura = registro.temperatura;
                let umidade = registro.umidade;

                // Ajustar valores para gráficos 1 e 3
                if (graficoIndex !== 2) {
                    const fatorVariacao = (idSensor % 10) * 0.01 + 0.02;

                    if (graficoIndex === 1) {
                        temperatura = registro.temperatura * (1 + fatorVariacao);
                        umidade = registro.umidade * (1 - fatorVariacao);
                    } else if (graficoIndex === 3) {
                        temperatura = registro.temperatura * (1 - fatorVariacao);
                        umidade = registro.umidade * (1 + fatorVariacao);
                    }
                    console.log('Fator: ', fatorVariacao)
                }

                labels.push(registro.momento_grafico);
                dadosTemp.datasets[0].data.push(temperatura);
                dadosUmid.datasets[0].data.push(umidade);
            });

            console.log('----------------------------------------------')
            console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
            console.log(resposta)

            while (labels.length < 10) {
                const ultimoHorario = labels.length > 0 ? labels[labels.length - 1] : "";

                const baseTemp = dadosTemp.datasets[0].data.length > 0
                    ? dadosTemp.datasets[0].data[dadosTemp.datasets[0].data.length - 1]
                    : (graficoIndex === 2 ? 25 : (graficoIndex === 1 ? 26 : 24));

                const baseUmid = dadosUmid.datasets[0].data.length > 0
                    ? dadosUmid.datasets[0].data[dadosUmid.datasets[0].data.length - 1]
                    : (graficoIndex === 2 ? 13 : (graficoIndex === 1 ? 12.5 : 13.5));

                labels.push(ultimoHorario);
                dadosTemp.datasets[0].data.push(baseTemp);
                dadosUmid.datasets[0].data.push(baseUmid);
            }

            console.log('----------------------------------------------')
            console.log('O gráfico será plotado com os respectivos valores:')
            console.log('Labels:')
            console.log(labels)
            console.log('Dados:')
            console.log(dadosTemp.datasets)
            console.log(dadosUmid.datasets)
            console.log('----------------------------------------------')

            // Criando estrutura para plotar gráfico - config
            const configTemp = {
                type: 'line',
                data: dadosTemp,
                options: {
                    scales: {
                        y: {
                            min: 18,
                            max: 31,
                            title: {
                                display: true,
                                text: '(°C)'
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            // position: 'bottom',
                            // labels: {
                            //     boxWidth: 15,
                            //     padding: 10,
                            //     filter: function (legendItem, data) {
                            //         return legendItem.text === 'Temperatura atual';
                            //     }
                            // }
                        }
                    }
                }
            };

            const configUmid = {
                type: 'line',
                data: dadosUmid,
                options: {
                    scales: {
                        y: {
                            min: 10,
                            max: 16,
                            title: {
                                display: true,
                                text: '(%)'
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            // position: 'bottom',
                            // labels: {
                            //     boxWidth: 15,
                            //     padding: 10,
                            //     filter: function (legendItem, data) {
                            //         return legendItem.text === 'Umidade atual';
                            //     }
                            // }
                        }
                    }
                }
            };

            // Adicionando gráfico criado em div na tela
            let myChartTemp = new Chart(
                document.getElementById(`grafico_temperatura_${graficoIndex}`),
                configTemp
            );

            let myChartUmid = new Chart(
                document.getElementById(`grafico_umidade_${graficoIndex}`),
                configUmid
            );
            setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid, graficoIndex), 500);
        }

        function atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid, graficoIndex) {
            fetch(`/medidas/tempo-real/${idSensor}`, { cache: 'no-store' })
                .then(response => {
                    if (!response.ok) throw new Error('Erro na API');
                    return response.json();
                })
                .then(novoRegistro => {
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

                    // Atualiza temperatura
                    let temperatura = novoRegistro[novoRegistro.length - 1].temperatura;
                    let umidade = novoRegistro[novoRegistro.length - 1].umidade;

                    if (graficoIndex !== 2) {
                        const fator = (idSensor % 10) * 0.01 + 0.02;
                        if (graficoIndex === 1) {
                            temperatura *= (1 + fator);
                            umidade *= (1 - fator);
                        } else {
                            temperatura *= (1 - fator);
                            umidade *= (1 + fator);
                        }
                    }
                    // Atualiza os dados dos gráficos
                    if (dados.labels.length >= 10) {
                        dados.labels.shift();
                        myChartTemp.data.datasets[0].data.shift();
                        myChartUmid.data.datasets[0].data.shift();
                    }

                    // Adiciona novos dados
                    dados.labels.push(novoRegistro[novoRegistro.length - 1].momento_grafico);

                    // Temperatura
                    myChartTemp.data.labels = dados.labels;
                    myChartTemp.data.datasets[0].data.push(temperatura);
                    // Mantém os datasets de máx e mín estáticos

                    // Umidade
                    myChartUmid.data.labels = dados.labels;
                    myChartUmid.data.datasets[0].data.push(umidade);
                    // Atualiza os gráficos
                    myChartTemp.update();
                    myChartUmid.update();
                    condicaoSilo()
                    // Agenda próxima atualização
                    setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid, graficoIndex), 15000);
                })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    // Tenta novamente em caso de erro
                    setTimeout(() => atualizarGrafico(idSensor, dados, myChartTemp, myChartUmid, graficoIndex), 15000);
                });
        }

        function initIndicators() {
            const indicatorsContainer = document.createElement('div');
            indicatorsContainer.className = 'carousel-indicators';

            carouselItems.forEach((_, index) => {
                const indicator = document.createElement('span');
                indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
                indicator.onclick = () => {
                    stopCarousel();
                    goToSlide(index);
                    timeoutId = setTimeout(startCarousel, 10000);
                };
                indicatorsContainer.appendChild(indicator);
            });

            carousel.appendChild(indicatorsContainer);
        }

        // Chama a função para inicializar os indicadores quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', initIndicators);

        function gerar() {
            tabelaHistorico.style.display = 'flex';
            var idSensor = sessionStorage.getItem('idSensorAtual');
            var idSilo = sessionStorage.getItem('idSiloAtual');
            var numeroSilo = document.getElementById('tabelaSilo');
            var dataHistorico = document.getElementById('dataHistorico');

            numeroSilo.innerHTML = `${idSilo}`;

            fetch(`/medidas/gerarHistorico/${idSensor}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function (resultado) {
                return resultado.json();
            })
                .then(function (tabela) {
                    console.log(tabela)
                    gerarTabela(tabela, idSensor)
                })
                .catch(function (error) {
                    console.log('Ocorreu um erro:', error);
                });
        }

        function gerarTabela(tabela, idSensor) {
            var data = 0;
            var tabelaDados1 = '';
            var tabelaDados2 = '';
            var tabelaDados3 = '';

            const fator = (idSensor % 10) * 0.01 + 0.02;

            for (var i = 0; i < tabela.length; i++) {
                var cor = '';
                if (tabela[i].temperatura * (1 + fator) < 20 || tabela[i].temperatura * (1 + fator) > 30 ||
                    tabela[i].umidade * (1 - fator) < 12 || tabela[i].umidade * (1 - fator) > 14) {
                    cor = 'corAlerta';
                }
                tabelaDados1 += `<tr>
                                <td class="${cor}">${tabela[i].data}</td>
                                <td class="${cor}">${(tabela[i].temperatura * (1 + fator)).toFixed(2)}</td>
                                <td class="${cor}">${(tabela[i].umidade * (1 - fator)).toFixed(2)}</td>
                            </tr>`;
                cor = '';
                if (tabela[i].temperatura < 20 || tabela[i].temperatura > 30 ||
                    tabela[i].umidade < 12 || tabela[i].umidade > 14) {
                    cor = 'corAlerta';
                }
                tabelaDados2 += `<tr>
                                <td class="${cor}">${tabela[i].data}</td>
                                <td class="${cor}">${tabela[i].temperatura}</td>
                                <td class="${cor}">${tabela[i].umidade}</td>
                            </tr>`;
                cor = '';
                if (tabela[i].temperatura * (1 - fator) < 20 || tabela[i].temperatura * (1 - fator) > 30 ||
                    tabela[i].umidade * (1 + fator) < 12 || tabela[i].umidade * (1 + fator) > 14) {
                    cor = 'corAlerta';
                }
                tabelaDados3 += `<tr>
                                <td class="${cor}">${tabela[i].data}</td>
                                <td class="${cor}">${(tabela[i].temperatura * (1 - fator)).toFixed(2)}</td>
                                <td class="${cor}">${(tabela[i].umidade * (1 + fator)).toFixed(2)}</td>
                            </tr>`;
            }
            dataHistorico.innerHTML = `Até a data de hoje: ${tabela[0].data.split(' ')[0]}`;
            var tabela1 = document.getElementById('tabela_historico1');
            var tabela2 = document.getElementById('tabela_historico2');
            var tabela3 = document.getElementById('tabela_historico3');

            tabela1.innerHTML = `<p>Sensor Superior</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Temperatura (°C)</th>
                                <th>Umidade (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tabelaDados1}
                        </tbody>
                    </table>`;

            tabela2.innerHTML = `<p>Sensor Meio</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Temperatura (°C)</th>
                                <th>Umidade (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tabelaDados2}
                        </tbody>
                    </table>`;

            tabela3.innerHTML = `<p>Sensor Base</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Temperatura (°C)</th>
                                <th>Umidade (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tabelaDados3}
                        </tbody>
                    </table>`;
        }
    </script>

</html>